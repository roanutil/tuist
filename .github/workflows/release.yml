name: Release

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: write
  pull-requests: read
  statuses: write
  packages: write

concurrency:
  group: release-workflow-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_HOME: ~/.pnpm
  TUIST_ENABLE_CACHING: "true"

jobs:
  check-releases:
    name: Check for releasable changes
    runs-on: namespace-profile-default-with-volume
    timeout-minutes: 15
    outputs:
      cli-should-release: ${{ steps.cli-check.outputs.should-release }}
      cli-next-version: ${{ steps.cli-check.outputs.next-version }}
      cli-next-version-number: ${{ steps.cli-check.outputs.next-version-number }}
      app-should-release: ${{ steps.app-check.outputs.should-release }}
      app-next-version: ${{ steps.app-check.outputs.next-version }}
      app-next-version-number: ${{ steps.app-check.outputs.next-version-number }}
      server-should-release: ${{ steps.server-check.outputs.should-release }}
      server-next-version: ${{ steps.server-check.outputs.next-version }}
      server-next-version-number: ${{ steps.server-check.outputs.next-version-number }}
      cache-should-release: ${{ steps.cache-check.outputs.should-release }}
      cache-next-version: ${{ steps.cache-check.outputs.next-version }}
      cache-next-version-number: ${{ steps.cache-check.outputs.next-version-number }}
      gradle-should-release: ${{ steps.gradle-check.outputs.should-release }}
      gradle-next-version: ${{ steps.gradle-check.outputs.next-version }}
      gradle-next-version-number: ${{ steps.gradle-check.outputs.next-version-number }}
      skills-should-release: ${{ steps.skills-check.outputs.should-release }}
      skills-next-version: ${{ steps.skills-check.outputs.next-version }}
      skills-next-version-number: ${{ steps.skills-check.outputs.next-version-number }}
      should-release-any: ${{ steps.check-any.outputs.should-release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: mise
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "git-cliff"
          cache: "false"

      - name: Check CLI for releasable changes
        id: cli-check
        run: |
          cd cli
          # Get the latest CLI version tag dynamically
          LATEST_VERSION=$(git tag -l | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || echo "0.0.0")

          # Check if there are any releasable changes by generating changelog
          CHANGELOG=$(git cliff --include-path "cli/**/*" --include-path ".xcode-version-releases" --config cliff.toml --repository "../" 2>/dev/null -- ${LATEST_VERSION}..HEAD || echo "")

          # Only bump version if there are actual release notes
          if echo "$CHANGELOG" | sed -n '/<!-- RELEASE NOTES START -->/,/<!-- generated by git-cliff -->/p' | grep -qE '^\*'; then
            NEXT_VERSION=$(git cliff --include-path "cli/**/*" --include-path ".xcode-version-releases" --config cliff.toml --repository "../" --bumped-version 2>/dev/null -- ${LATEST_VERSION}..HEAD)
          else
            NEXT_VERSION="$LATEST_VERSION"
          fi

          echo "Latest CLI version: $LATEST_VERSION"
          echo "Next CLI version: $NEXT_VERSION"

          # Validate that next version is actually newer
          if [ "$NEXT_VERSION" = "$LATEST_VERSION" ]; then
            echo "No CLI version change detected (versions are equal)"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "next-version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
          elif [ "$(printf '%s\n' "$LATEST_VERSION" "$NEXT_VERSION" | sort -V | head -n1)" = "$NEXT_VERSION" ]; then
            echo "ERROR: Next version ($NEXT_VERSION) is older than latest version ($LATEST_VERSION)"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "next-version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "CLI version bump detected: $LATEST_VERSION -> $NEXT_VERSION"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
            echo "next-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          fi

      - name: Check App for releasable changes
        id: app-check
        run: |
          cd app
          # Get the latest app version tag
          LATEST_VERSION=$(git tag -l | grep -E "^app@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          # Check if there are any releasable changes by generating changelog
          if [ -n "$LATEST_VERSION" ]; then
            CHANGELOG=$(git cliff --include-path "app/**/*" --include-path "mise/tasks/app/**/*" --config cliff.toml --repository "../" 2>/dev/null -- ${LATEST_VERSION}..HEAD || echo "")
          else
            CHANGELOG=$(git cliff --include-path "app/**/*" --include-path "mise/tasks/app/**/*" --config cliff.toml --repository "../" 2>/dev/null || echo "")
          fi

          # Only bump version if there are actual release notes
          if echo "$CHANGELOG" | sed -n '/<!-- RELEASE NOTES START -->/,/<!-- generated by git-cliff -->/p' | grep -qE '^\*'; then
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION=$(git cliff --include-path "app/**/*" --include-path "mise/tasks/app/**/*" --config cliff.toml --repository "../" --bumped-version 2>/dev/null -- ${LATEST_VERSION}..HEAD)
            else
              NEXT_VERSION=$(git cliff --include-path "app/**/*" --include-path "mise/tasks/app/**/*" --config cliff.toml --repository "../" --bumped-version 2>/dev/null)
            fi
          else
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION="${LATEST_VERSION#app@}"
            else
              NEXT_VERSION="0.1.0"
            fi
          fi

          # Add app@ prefix if not present and remove any duplicate prefixes
          if [[ "$NEXT_VERSION" == app@* ]]; then
            # If it already has app@ prefix, extract just the version number and re-add single prefix
            VERSION_NUM="${NEXT_VERSION#app@}"
            # Remove any additional app@ prefixes
            while [[ "$VERSION_NUM" == app@* ]]; do
              VERSION_NUM="${VERSION_NUM#app@}"
            done
            NEXT_VERSION="app@$VERSION_NUM"
          else
            NEXT_VERSION="app@$NEXT_VERSION"
          fi

          echo "Latest App version: ${LATEST_VERSION:-none}"
          echo "Next App version: $NEXT_VERSION"

          # Validate and compare versions
          if [ -z "$LATEST_VERSION" ]; then
            # No previous version, this is the first release
            echo "First App release: $NEXT_VERSION"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
            echo "next-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${NEXT_VERSION#app@}" >> "$GITHUB_OUTPUT"
          elif [ "$NEXT_VERSION" = "$LATEST_VERSION" ]; then
            echo "No App version change detected (versions are equal)"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "next-version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${LATEST_VERSION#app@}" >> "$GITHUB_OUTPUT"
          else
            echo "App version bump detected: $LATEST_VERSION -> $NEXT_VERSION"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
            echo "next-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${NEXT_VERSION#app@}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check Server for releasable changes
        id: server-check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest server version tag
          LATEST_VERSION=$(git tag -l | grep -E "^server@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          # Check if there are any releasable changes by generating changelog
          if [ -n "$LATEST_VERSION" ]; then
            CHANGELOG=$(git cliff --include-path "server/**/*" --config server/cliff.toml --repository "." 2>/dev/null -- ${LATEST_VERSION}..HEAD || echo "")
          else
            CHANGELOG=$(git cliff --include-path "server/**/*" --config server/cliff.toml --repository "." 2>/dev/null || echo "")
          fi

          # Only bump version if there are actual release notes
          if echo "$CHANGELOG" | sed -n '/<!-- RELEASE NOTES START -->/,/<!-- generated by git-cliff -->/p' | grep -qE '^\*'; then
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION=$(git cliff --include-path "server/**/*" --config server/cliff.toml --repository "." --bumped-version 2>/dev/null -- ${LATEST_VERSION}..HEAD)
            else
              NEXT_VERSION=$(git cliff --include-path "server/**/*" --config server/cliff.toml --repository "." --bumped-version 2>/dev/null)
            fi
          else
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION="${LATEST_VERSION#server@}"
            else
              echo "No server tags or server-scoped commits found, defaulting to initial version"
              NEXT_VERSION="0.1.0"
            fi
          fi

          # Add server@ prefix if not present and remove any duplicate prefixes
          if [[ "$NEXT_VERSION" == server@* ]]; then
            # If it already has server@ prefix, extract just the version number and re-add single prefix
            VERSION_NUM="${NEXT_VERSION#server@}"
            # Remove any additional server@ prefixes
            while [[ "$VERSION_NUM" == server@* ]]; do
              VERSION_NUM="${VERSION_NUM#server@}"
            done
            NEXT_VERSION="server@$VERSION_NUM"
          else
            NEXT_VERSION="server@$NEXT_VERSION"
          fi

          echo "Latest Server version: ${LATEST_VERSION:-none}"
          echo "Next Server version: $NEXT_VERSION"

          # Compare versions to determine if release is needed
          if [ "$LATEST_VERSION" != "$NEXT_VERSION" ]; then
            echo "Server version bump detected: ${LATEST_VERSION:-none} -> $NEXT_VERSION"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
            echo "next-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${NEXT_VERSION#server@}" >> "$GITHUB_OUTPUT"
          else
            echo "No Server version change detected"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "next-version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${LATEST_VERSION#server@}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check Cache for releasable changes
        id: cache-check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest cache version tag
          LATEST_VERSION=$(git tag -l | grep -E "^cache@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          # Check if there are any releasable changes by generating changelog
          if [ -n "$LATEST_VERSION" ]; then
            CHANGELOG=$(git cliff --include-path "cache/**/*" --config cache/cliff.toml --repository "." 2>/dev/null -- ${LATEST_VERSION}..HEAD || echo "")
          else
            CHANGELOG=$(git cliff --include-path "cache/**/*" --config cache/cliff.toml --repository "." 2>/dev/null || echo "")
          fi

          # Only bump version if there are actual release notes
          if echo "$CHANGELOG" | sed -n '/<!-- RELEASE NOTES START -->/,/<!-- generated by git-cliff -->/p' | grep -qE '^\*'; then
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION=$(git cliff --include-path "cache/**/*" --config cache/cliff.toml --repository "." --bumped-version 2>/dev/null -- ${LATEST_VERSION}..HEAD)
            else
              NEXT_VERSION=$(git cliff --include-path "cache/**/*" --config cache/cliff.toml --repository "." --bumped-version 2>/dev/null)
            fi
          else
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION="${LATEST_VERSION#cache@}"
            else
              echo "No cache tags or cache-scoped commits found, defaulting to initial version"
              NEXT_VERSION="0.1.0"
            fi
          fi

          # Add cache@ prefix if not present and remove any duplicate prefixes
          if [[ "$NEXT_VERSION" == cache@* ]]; then
            # If it already has cache@ prefix, extract just the version number and re-add single prefix
            VERSION_NUM="${NEXT_VERSION#cache@}"
            # Remove any additional cache@ prefixes
            while [[ "$VERSION_NUM" == cache@* ]]; do
              VERSION_NUM="${VERSION_NUM#cache@}"
            done
            NEXT_VERSION="cache@$VERSION_NUM"
          else
            NEXT_VERSION="cache@$NEXT_VERSION"
          fi

          echo "Latest Cache version: ${LATEST_VERSION:-none}"
          echo "Next Cache version: $NEXT_VERSION"

          # Compare versions to determine if release is needed
          if [ "$LATEST_VERSION" != "$NEXT_VERSION" ]; then
            echo "Cache version bump detected: ${LATEST_VERSION:-none} -> $NEXT_VERSION"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
            echo "next-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${NEXT_VERSION#cache@}" >> "$GITHUB_OUTPUT"
          else
            echo "No Cache version change detected"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "next-version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${LATEST_VERSION#cache@}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check Gradle for releasable changes
        id: gradle-check
        run: |
          # Get the latest gradle version tag
          LATEST_VERSION=$(git tag -l | grep -E "^gradle@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          # Check if there are any releasable changes by generating changelog
          if [ -n "$LATEST_VERSION" ]; then
            CHANGELOG=$(git cliff --config gradle/cliff.toml --repository "." 2>/dev/null -- ${LATEST_VERSION}..HEAD || echo "")
          else
            CHANGELOG=$(git cliff --config gradle/cliff.toml --repository "." 2>/dev/null || echo "")
          fi

          # Only bump version if there are actual release notes
          if echo "$CHANGELOG" | sed -n '/<!-- RELEASE NOTES START -->/,/<!-- generated by git-cliff -->/p' | grep -qE '^\*'; then
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION=$(git cliff --config gradle/cliff.toml --repository "." --bumped-version 2>/dev/null -- ${LATEST_VERSION}..HEAD)
            else
              NEXT_VERSION=$(git cliff --config gradle/cliff.toml --repository "." --bumped-version 2>/dev/null)
            fi
          else
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION="${LATEST_VERSION#gradle@}"
            else
              echo "No gradle tags or gradle-scoped commits found, defaulting to initial version"
              NEXT_VERSION="0.1.0"
            fi
          fi

          # Add gradle@ prefix if not present and remove any duplicate prefixes
          if [[ "$NEXT_VERSION" == gradle@* ]]; then
            # If it already has gradle@ prefix, extract just the version number and re-add single prefix
            VERSION_NUM="${NEXT_VERSION#gradle@}"
            # Remove any additional gradle@ prefixes
            while [[ "$VERSION_NUM" == gradle@* ]]; do
              VERSION_NUM="${VERSION_NUM#gradle@}"
            done
            NEXT_VERSION="gradle@$VERSION_NUM"
          else
            NEXT_VERSION="gradle@$NEXT_VERSION"
          fi

          echo "Latest Gradle version: ${LATEST_VERSION:-none}"
          echo "Next Gradle version: $NEXT_VERSION"

          # Compare versions to determine if release is needed
          if [ "$LATEST_VERSION" != "$NEXT_VERSION" ]; then
            echo "Gradle version bump detected: ${LATEST_VERSION:-none} -> $NEXT_VERSION"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
            echo "next-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${NEXT_VERSION#gradle@}" >> "$GITHUB_OUTPUT"
          else
            echo "No Gradle version change detected"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "next-version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${LATEST_VERSION#gradle@}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check Skills for releasable changes
        id: skills-check
        run: |
          # Get the latest skills version tag
          LATEST_VERSION=$(git tag -l | grep -E "^skills@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          # Check if there are any releasable changes by generating changelog
          if [ -n "$LATEST_VERSION" ]; then
            CHANGELOG=$(git cliff --include-path "skills/**/*" --config skills/cliff.toml --repository "." 2>/dev/null -- ${LATEST_VERSION}..HEAD || echo "")
          else
            CHANGELOG=$(git cliff --include-path "skills/**/*" --config skills/cliff.toml --repository "." 2>/dev/null || echo "")
          fi

          # Only bump version if there are actual release notes
          if echo "$CHANGELOG" | sed -n '/<!-- RELEASE NOTES START -->/,/<!-- generated by git-cliff -->/p' | grep -qE '^\*'; then
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION=$(git cliff --include-path "skills/**/*" --config skills/cliff.toml --repository "." --bumped-version 2>/dev/null -- ${LATEST_VERSION}..HEAD)
            else
              NEXT_VERSION=$(git cliff --include-path "skills/**/*" --config skills/cliff.toml --repository "." --bumped-version 2>/dev/null)
            fi
          else
            if [ -n "$LATEST_VERSION" ]; then
              NEXT_VERSION="${LATEST_VERSION#skills@}"
            else
              echo "No skills tags or skills-scoped commits found, defaulting to initial version"
              NEXT_VERSION="0.1.0"
            fi
          fi

          # Add skills@ prefix if not present and remove any duplicate prefixes
          if [[ "$NEXT_VERSION" == skills@* ]]; then
            # If it already has skills@ prefix, extract just the version number and re-add single prefix
            VERSION_NUM="${NEXT_VERSION#skills@}"
            # Remove any additional skills@ prefixes
            while [[ "$VERSION_NUM" == skills@* ]]; do
              VERSION_NUM="${VERSION_NUM#skills@}"
            done
            NEXT_VERSION="skills@$VERSION_NUM"
          else
            NEXT_VERSION="skills@$NEXT_VERSION"
          fi

          echo "Latest Skills version: ${LATEST_VERSION:-none}"
          echo "Next Skills version: $NEXT_VERSION"

          # Compare versions to determine if release is needed
          if [ "$LATEST_VERSION" != "$NEXT_VERSION" ]; then
            echo "Skills version bump detected: ${LATEST_VERSION:-none} -> $NEXT_VERSION"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
            echo "next-version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${NEXT_VERSION#skills@}" >> "$GITHUB_OUTPUT"
          else
            echo "No Skills version change detected"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
            echo "next-version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "next-version-number=${LATEST_VERSION#skills@}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if any component needs release
        id: check-any
        run: |
          if [ "${{ steps.cli-check.outputs.should-release }}" == "true" ] || \
             [ "${{ steps.app-check.outputs.should-release }}" == "true" ] || \
             [ "${{ steps.server-check.outputs.should-release }}" == "true" ] || \
             [ "${{ steps.cache-check.outputs.should-release }}" == "true" ] || \
             [ "${{ steps.gradle-check.outputs.should-release }}" == "true" ] || \
             [ "${{ steps.skills-check.outputs.should-release }}" == "true" ]; then
            echo "At least one component needs release"
            echo "should-release=true" >> "$GITHUB_OUTPUT"
          else
            echo "No components need release"
            echo "should-release=false" >> "$GITHUB_OUTPUT"
          fi

  release-cli:
    name: Release CLI
    needs: check-releases
    if: needs.check-releases.outputs.cli-should-release == 'true'
    runs-on: macos-26
    timeout-minutes: 50
    env:
      GITHUB_TOKEN: ${{ secrets.TUIST_GITHUB_TOKEN }}
    outputs:
      artifacts-uploaded: ${{ steps.upload.outputs.uploaded }}
      release-notes: ${{ steps.release-notes.outputs.RELEASE_NOTES }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TUIST_GITHUB_TOKEN }}
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version-releases).app
      - name: Restore cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .build
          key: ${{ runner.os }}-cli-release-${{ hashFiles('.xcode-version-releases') }}-${{ hashFiles('Package.resolved') }}
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "tuist git-cliff 1password-cli"
          cache: "false"
      - name: Authenticate with Tuist
        run: tuist auth login
      - name: Setup Tuist cache
        run: tuist setup cache
      - name: Install Tuist dependencies
        if: steps.cache-restore.outputs.cache-matched-key == ''
        run: tuist install
      - name: Initialize TuistCacheEE submodule
        env:
          TUIST_GITHUB_TOKEN: ${{ secrets.TUIST_GITHUB_TOKEN }}
        run: mise run --no-prepare cli:ee
      - name: Get release notes
        id: release-notes
        working-directory: cli
        run: |
          # Get the latest CLI version tag dynamically
          LATEST_VERSION=$(git tag -l | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || echo "0.0.0")
          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          git cliff --include-path "cli/**/*" --include-path ".xcode-version-releases" --config cliff.toml --repository "../" 2>/dev/null -- ${LATEST_VERSION}..HEAD | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Update version in Constants.swift
        run: |
          sed -i '' -e "s/@TaskLocal public static var version: String! = \".*\"/@TaskLocal public static var version: String! = \"${{ needs.check-releases.outputs.cli-next-version }}\"/" "cli/Sources/TuistConstants/Constants.swift"

      - name: Update CHANGELOG.md
        working-directory: cli
        run: git cliff --include-path "cli/**/*" --include-path ".xcode-version-releases" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null

      - name: Bundle CLI
        run: mise run --no-prepare cli:bundle
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Update mise.toml
        run: |
          sed -i '' "s/tuist = \".*\"/tuist = \"${{ needs.check-releases.outputs.cli-next-version }}\"/" mise.toml

      - name: Save cache
        id: cache-save
        uses: actions/cache/save@v4
        with:
          path: .build
          key: ${{ steps.cache-restore.outputs.cache-primary-key }}

      - name: Upload CLI artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: cli-artifacts
          path: |
            cli/CHANGELOG.md
            cli/Sources/TuistConstants/Constants.swift
            mise.toml
            build/ProjectDescription.xcframework.zip
            build/tuist.zip
            build/SHASUMS256.txt
            build/SHASUMS512.txt
          retention-days: 1

  release-cli-linux:
    name: Release CLI (Linux ${{ matrix.arch }})
    needs: check-releases
    if: needs.check-releases.outputs.cli-should-release == 'true'
    runs-on: ${{ matrix.runner }}
    container:
      image: swift:6.2
    timeout-minutes: 30
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: aarch64
            runner: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TUIST_GITHUB_TOKEN }}

      - name: Cache Static Linux SDK
        uses: actions/cache@v4
        with:
          path: ~/.swiftpm/swift-sdks
          key: static-linux-sdk-swift-6.2.3-${{ matrix.arch }}

      - name: Restore cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .build
          key: linux-${{ matrix.arch }}-cli-release-${{ hashFiles('Package.resolved') }}

      - name: Update version in Constants.swift
        run: |
          sed -i "s/@TaskLocal public static var version: String! = \".*\"/@TaskLocal public static var version: String! = \"${{ needs.check-releases.outputs.cli-next-version }}\"/" "cli/Sources/TuistConstants/Constants.swift"

      - name: Bundle CLI
        run: ./mise/tasks/cli/bundle-linux.sh

      - name: Save cache
        uses: actions/cache/save@v4
        with:
          path: .build
          key: ${{ steps.cache-restore.outputs.cache-primary-key }}

      - name: Upload CLI Linux artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: cli-linux-${{ matrix.arch }}-artifacts
          path: |
            build/tuist-linux-${{ matrix.arch }}.tar.gz
            build/SHASUMS256.txt
            build/SHASUMS512.txt
          retention-days: 1

  release-app:
    name: Release App
    needs: check-releases
    if: needs.check-releases.outputs.app-should-release == 'true'
    runs-on: macos-26
    timeout-minutes: 50
    env:
      GITHUB_TOKEN: ${{ secrets.TUIST_GITHUB_TOKEN }}
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
    outputs:
      artifacts-uploaded: ${{ steps.upload.outputs.uploaded }}
      release-notes: ${{ steps.release-notes.outputs.RELEASE_NOTES }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TUIST_GITHUB_TOKEN }}
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version).app
      - name: Install create-dmg
        run: brew install create-dmg
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "tuist git-cliff 1password-cli"
          cache: "false"
      - name: Authenticate with Tuist
        run: tuist auth login
      - name: Setup Tuist cache
        run: tuist setup cache
      - name: Install dependencies
        run: tuist install

      - name: Get release notes
        id: release-notes
        working-directory: app
        run: |
          # Get the latest app version tag
          LATEST_VERSION=$(git tag -l | grep -E "^app@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "app/**/*" --include-path "mise/tasks/app/**/*" --config cliff.toml --repository "../" 2>/dev/null -- ${LATEST_VERSION}..HEAD | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          else
            git cliff --include-path "app/**/*" --include-path "mise/tasks/app/**/*" --config cliff.toml --repository "../" 2>/dev/null | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Update version
        working-directory: app
        run: |
          VERSION_NUMBER="${{ needs.check-releases.outputs.app-next-version }}"
          VERSION_NUMBER="${VERSION_NUMBER#app@}"
          sed -i '' -e "s/CFBundleShortVersionString.*/CFBundleShortVersionString\": \"$VERSION_NUMBER\",/g" "Project.swift"
          # +10000 offset ensures build numbers stay above 9127, the last value produced by
          # the previous scheme before github.run_number was adopted (the run counter reset
          # to ~3200 when the workflow was recreated, going below the old high-water mark).
          BUILD_NUMBER=$(( ${{ github.run_number }} + 10000 ))
          sed -i '' -e "s/CFBundleVersion.*/CFBundleVersion\": \"${BUILD_NUMBER}\",/g" "Project.swift"

      - name: Update CHANGELOG.md
        working-directory: app
        run: |
          # Get the latest app version tag
          LATEST_VERSION=$(git tag -l | grep -E "^app@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "app/**/*" --include-path "mise/tasks/app/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null -- ${LATEST_VERSION}..HEAD
          else
            git cliff --include-path "app/**/*" --include-path "mise/tasks/app/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null
          fi

      - name: Bundle macOS app
        run: mise run --no-prepare app:bundle
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Generate Sparkle appcast
        run: op read "op://tuist/Tuist App Private Sparkle Key/credential" | .build/artifacts/sparkle-project.Sparkle/Sparkle/bin/generate_appcast --link https://github.com/tuist/tuist/releases --download-url-prefix https://github.com/tuist/tuist/releases/download/${{ needs.check-releases.outputs.app-next-version }}/Tuist.dmg -o app/appcast.xml app/build/artifacts --ed-key-file -

      - name: Upload App artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: app-artifacts
          path: |
            app/CHANGELOG.md
            app/Project.swift
            app/appcast.xml
            app/build/artifacts/Tuist.zip
            app/build/artifacts/Tuist.dmg
            app/build/artifacts/SHASUMS256.txt
            app/build/artifacts/SHASUMS512.txt
          retention-days: 1

  release-ios:
    name: Release iOS App
    needs: check-releases
    if: needs.check-releases.outputs.app-should-release == 'true'
    runs-on: macos-26
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TUIST_GITHUB_TOKEN }}
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_$(cat .xcode-version).app
      - name: Skip Xcode Macro Fingerprint Validation
        run: defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES
      - name: Skip Xcode Package Validation
        run: defaults write com.apple.dt.Xcode IDESkipPackagePluginFingerprintValidation -bool YES
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "tuist 1password-cli"
          cache: "false"
      - name: Authenticate with Tuist
        run: tuist auth login
      - name: Setup Tuist cache
        run: tuist setup cache
      - name: Restore cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .build
          key: ${{ runner.os }}-app-${{ hashFiles('Package.resolved') }}
      - name: Update version
        working-directory: app
        run: |
          VERSION_NUMBER="${{ needs.check-releases.outputs.app-next-version }}"
          VERSION_NUMBER="${VERSION_NUMBER#app@}"
          sed -i '' -e "s/CFBundleShortVersionString.*/CFBundleShortVersionString\": \"$VERSION_NUMBER\",/g" "Project.swift"
          sed -i '' -e "s/CFBundleVersion.*/CFBundleVersion\": \"${{ github.run_number }}\",/g" "Project.swift"
      - name: Install Tuist dependencies
        if: steps.cache-restore.outputs.cache-matched-key == ''
        run: tuist install
      - name: Generate TuistApp
        run: tuist generate TuistApp --no-binary-cache
      - name: Upload iOS App to App Store Connect
        run: mise run --no-prepare app:upload-ios
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

  release-android:
    name: Release Android App
    needs: check-releases
    if: needs.check-releases.outputs.app-should-release == 'true'
    runs-on: namespace-profile-default-with-volume
    timeout-minutes: 30
    env:
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TUIST_GITHUB_TOKEN }}

      - uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: mise
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "java gradle 1password-cli"
          cache: "false"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Update version
        working-directory: android
        run: |
          VERSION_NUMBER="${{ needs.check-releases.outputs.app-next-version }}"
          VERSION_NUMBER="${VERSION_NUMBER#app@}"
          sed -i "s/versionCode = .*/versionCode = ${{ github.run_number }}/" app/build.gradle.kts
          sed -i "s/versionName = \".*\"/versionName = \"$VERSION_NUMBER\"/" app/build.gradle.kts

      - name: Setup signing and credentials
        run: |
          op document get "Google Play release.keystore binary" --vault tuist --out-file android/release.keystore
          op read "op://tuist/Google Play release.keystore/sirudpicoo6z2b3rmdtfhcj3aa" --out-file android/service-account.json

      - name: Publish to Google Play
        working-directory: android
        run: |
          export ANDROID_KEYSTORE_PASSWORD=$(op read "op://tuist/Google Play release.keystore/password")
          export ANDROID_KEY_ALIAS=tuist
          export ANDROID_KEY_PASSWORD=$(op read "op://tuist/Google Play release.keystore/password")
          ./gradlew publishReleaseBundle

  release-server:
    name: Release Server
    needs: check-releases
    if: needs.check-releases.outputs.server-should-release == 'true'
    runs-on: namespace-profile-default-with-volume
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      artifacts-uploaded: ${{ steps.upload.outputs.uploaded }}
      release-notes: ${{ steps.release-notes.outputs.RELEASE_NOTES }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: mise
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "git-cliff"
          cache: "false"

      - name: Get release notes
        id: release-notes
        working-directory: server
        run: |
          # Get the latest server version tag
          LATEST_VERSION=$(git tag -l | grep -E "^server@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "server/**/*" --config cliff.toml --repository "../" 2>/dev/null -- ${LATEST_VERSION}..HEAD | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          else
            git cliff --include-path "server/**/*" --config cliff.toml --repository "../" 2>/dev/null | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Update CHANGELOG.md
        working-directory: server
        run: |
          # Get the latest server version tag
          LATEST_VERSION=$(git tag -l | grep -E "^server@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "server/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null -- ${LATEST_VERSION}..HEAD
          else
            git cliff --include-path "server/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null
          fi

      - name: Set up Docker Buildx
        uses: namespacelabs/nscloud-setup-buildx-action@v0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/tuist/tuist
          flavor: |
            latest=true
          tags: |
            type=raw,value=${{ needs.check-releases.outputs.server-next-version-number }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./server/Dockerfile
          push: true
          build-args: |
            TUIST_HOSTED=0
            TUIST_VERSION=${{ needs.check-releases.outputs.server-next-version-number }}
            MIX_ENV=prod
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Upload Server artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: server-artifacts
          path: |
            server/CHANGELOG.md
          retention-days: 1

  release-cache:
    name: Release Cache
    needs: check-releases
    if: needs.check-releases.outputs.cache-should-release == 'true'
    runs-on: namespace-profile-default-with-volume
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      artifacts-uploaded: ${{ steps.upload.outputs.uploaded }}
      release-notes: ${{ steps.release-notes.outputs.RELEASE_NOTES }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: mise
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "git-cliff"
          cache: "false"

      - name: Get release notes
        id: release-notes
        working-directory: cache
        run: |
          # Get the latest cache version tag
          LATEST_VERSION=$(git tag -l | grep -E "^cache@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "cache/**/*" --config cliff.toml --repository "../" 2>/dev/null -- ${LATEST_VERSION}..HEAD | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          else
            git cliff --include-path "cache/**/*" --config cliff.toml --repository "../" 2>/dev/null | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Update CHANGELOG.md
        working-directory: cache
        run: |
          # Get the latest cache version tag
          LATEST_VERSION=$(git tag -l | grep -E "^cache@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "cache/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null -- ${LATEST_VERSION}..HEAD
          else
            git cliff --include-path "cache/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null
          fi

      - name: Set up Docker Buildx
        uses: namespacelabs/nscloud-setup-buildx-action@v0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/tuist/cache
          flavor: |
            latest=true
          tags: |
            type=raw,value=${{ needs.check-releases.outputs.cache-next-version-number }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./cache/Dockerfile
          push: true
          build-args: |
            CACHE_VERSION=${{ needs.check-releases.outputs.cache-next-version-number }}
            MIX_ENV=prod
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Upload Cache artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: cache-artifacts
          path: |
            cache/CHANGELOG.md
          retention-days: 1

  release-gradle:
    name: Release Gradle Plugin
    needs: check-releases
    if: needs.check-releases.outputs.gradle-should-release == 'true'
    runs-on: namespace-profile-default-with-volume
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      artifacts-uploaded: ${{ steps.upload.outputs.uploaded }}
      release-notes: ${{ steps.release-notes.outputs.RELEASE_NOTES }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TUIST_GITHUB_TOKEN }}
      - uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: mise
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "java gradle git-cliff 1password-cli"
          cache: "false"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Get release notes
        id: release-notes
        run: |
          # Get the latest gradle version tag
          LATEST_VERSION=$(git tag -l | grep -E "^gradle@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          if [ -n "$LATEST_VERSION" ]; then
            RELEASE_NOTES=$(git cliff --config gradle/cliff.toml --repository "." 2>/dev/null -- ${LATEST_VERSION}..HEAD | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2)
          else
            RELEASE_NOTES=$(git cliff --config gradle/cliff.toml --repository "." 2>/dev/null | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2)
          fi

          if [ -z "$(echo "$RELEASE_NOTES" | tr -d '[:space:]')" ]; then
            echo "Gradle release notes are empty. Refusing to publish a release without notes." >&2
            exit 1
          fi

          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RELEASE_NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Update CHANGELOG.md
        working-directory: gradle
        run: |
          # Get the latest gradle version tag
          LATEST_VERSION=$(git tag -l | grep -E "^gradle@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "gradle/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null -- ${LATEST_VERSION}..HEAD
          else
            git cliff --include-path "gradle/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null
          fi

      - name: Update version in settings.gradle.kts
        run: |
          sed -i 's/id("dev.tuist") version ".*"/id("dev.tuist") version "${{ needs.check-releases.outputs.gradle-next-version-number }}"/' gradle/settings.gradle.kts

      - name: Publish to Gradle Plugin Portal
        working-directory: gradle
        run: |
          PUBLISH_KEY=$(op read "op://tuist/GRADLE_PUBLISH_KEY/password")
          PUBLISH_SECRET=$(op read "op://tuist/GRADLE_PUBLISH_SECRET/password")
          ./gradlew publishPlugins -Pversion=${{ needs.check-releases.outputs.gradle-next-version-number }} -Pgradle.publish.key="$PUBLISH_KEY" -Pgradle.publish.secret="$PUBLISH_SECRET"
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Tag Gradle release
        run: |
          TAG=${{ needs.check-releases.outputs.gradle-next-version }}

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git ls-remote --tags --exit-code origin "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists on origin"
            exit 0
          fi

          git tag "$TAG"
          git push origin "refs/tags/$TAG"

      - name: Create Gradle GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          repository: tuist/tuist
          name: Gradle Plugin ${{ needs.check-releases.outputs.gradle-next-version-number }}
          tag_name: ${{ needs.check-releases.outputs.gradle-next-version }}
          body: |
            Gradle Plugin Portal: `dev.tuist:${{ needs.check-releases.outputs.gradle-next-version-number }}`

            ${{ steps.release-notes.outputs.RELEASE_NOTES }}
        env:
          GITHUB_TOKEN: ${{ secrets.TUIST_GITHUB_TOKEN }}

      - name: Upload Gradle artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: gradle-artifacts
          path: |
            gradle/CHANGELOG.md
            gradle/settings.gradle.kts
            gradle/src/main/kotlin/dev/tuist/gradle/TuistBuildCache.kt
          retention-days: 1

  release-skills:
    name: Release Skills
    needs: check-releases
    if: needs.check-releases.outputs.skills-should-release == 'true'
    runs-on: namespace-profile-default-with-volume
    timeout-minutes: 15
    env:
      GITHUB_TOKEN: ${{ secrets.TUIST_GITHUB_TOKEN }}
    outputs:
      release-notes: ${{ steps.release-notes.outputs.RELEASE_NOTES }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: mise
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "git-cliff"
          cache: "false"

      - name: Get release notes
        id: release-notes
        run: |
          # Get the latest skills version tag
          LATEST_VERSION=$(git tag -l | grep -E "^skills@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "skills/**/*" --config skills/cliff.toml --repository "." 2>/dev/null -- ${LATEST_VERSION}..HEAD | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          else
            git cliff --include-path "skills/**/*" --config skills/cliff.toml --repository "." 2>/dev/null | sed -n '/<!-- RELEASE NOTES START -->/,$p' | tail -n +2 >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Update CHANGELOG.md
        working-directory: skills
        run: |
          # Get the latest skills version tag
          LATEST_VERSION=$(git tag -l | grep -E "^skills@[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n1)

          if [ -n "$LATEST_VERSION" ]; then
            git cliff --include-path "skills/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null -- ${LATEST_VERSION}..HEAD
          else
            git cliff --include-path "skills/**/*" --config cliff.toml --repository "../" --bump -o CHANGELOG.md 2>/dev/null
          fi

      - name: Push to tuist/agent-skills
        run: |
          VERSION="${{ needs.check-releases.outputs.skills-next-version-number }}"
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/tuist/agent-skills.git /tmp/agent-skills
          rm -rf /tmp/agent-skills/skills
          cp -r skills/skills /tmp/agent-skills/skills
          cd /tmp/agent-skills
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Release ${VERSION}"
            git tag "${VERSION}"
            git push origin main --tags
          else
            echo "No changes to push"
          fi

      - name: Upload Skills artifacts
        uses: actions/upload-artifact@v4
        with:
          name: skills-artifacts
          path: |
            skills/CHANGELOG.md
          retention-days: 1

  commit-and-release:
    name: Commit and Release
    needs:
      [
        check-releases,
        release-cli,
        release-cli-linux,
        release-app,
        release-ios,
        release-android,
        release-server,
        release-cache,
        release-gradle,
        release-skills,
      ]
    if: |
      always() &&
      needs.check-releases.outputs.should-release-any == 'true' &&
      (needs.release-cli.result == 'success' || needs.release-cli.result == 'skipped') &&
      (needs.release-cli-linux.result == 'success' || needs.release-cli-linux.result == 'skipped') &&
      (needs.release-app.result == 'success' || needs.release-app.result == 'skipped') &&
      (needs.release-ios.result == 'success' || needs.release-ios.result == 'skipped') &&
      (needs.release-android.result == 'success' || needs.release-android.result == 'skipped') &&
      (needs.release-server.result == 'success' || needs.release-server.result == 'skipped') &&
      (needs.release-cache.result == 'success' || needs.release-cache.result == 'skipped') &&
      (needs.release-gradle.result == 'success' || needs.release-gradle.result == 'skipped') &&
      (needs.release-skills.result == 'success' || needs.release-skills.result == 'skipped')
    runs-on: namespace-profile-default-with-volume
    timeout-minutes: 30
    concurrency:
      group: commit-and-release-${{ github.run_id }}
      cancel-in-progress: false
    env:
      GITHUB_TOKEN: ${{ secrets.TUIST_GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TUIST_GITHUB_TOKEN }}

      - uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: mise
      - uses: jdx/mise-action@v3.2.0
        with:
          install_args: "git-cliff"
          cache: "false"

      - name: Download CLI artifacts
        if: needs.check-releases.outputs.cli-should-release == 'true' && needs.release-cli.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: cli-artifacts

      - name: Download CLI Linux x86_64 artifacts
        if: needs.check-releases.outputs.cli-should-release == 'true' && needs.release-cli-linux.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: cli-linux-x86_64-artifacts
          path: build-linux-x86_64

      - name: Download CLI Linux aarch64 artifacts
        if: needs.check-releases.outputs.cli-should-release == 'true' && needs.release-cli-linux.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: cli-linux-aarch64-artifacts
          path: build-linux-aarch64

      - name: Merge Linux artifacts into build directory
        if: needs.check-releases.outputs.cli-should-release == 'true' && needs.release-cli-linux.result == 'success'
        run: |
          # Append Linux checksums to main checksum files
          cat build-linux-x86_64/SHASUMS256.txt >> build/SHASUMS256.txt
          cat build-linux-x86_64/SHASUMS512.txt >> build/SHASUMS512.txt
          cat build-linux-aarch64/SHASUMS256.txt >> build/SHASUMS256.txt
          cat build-linux-aarch64/SHASUMS512.txt >> build/SHASUMS512.txt
          # Move Linux tarballs to build directory
          mv build-linux-x86_64/tuist-linux-x86_64.tar.gz build/
          mv build-linux-aarch64/tuist-linux-aarch64.tar.gz build/

      - name: Download App artifacts
        if: needs.check-releases.outputs.app-should-release == 'true' && needs.release-app.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: app-artifacts
          path: app

      - name: Download Server artifacts
        if: needs.check-releases.outputs.server-should-release == 'true' && needs.release-server.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: server-artifacts

      - name: Download Cache artifacts
        if: needs.check-releases.outputs.cache-should-release == 'true' && needs.release-cache.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: cache-artifacts

      - name: Download Gradle artifacts
        if: needs.check-releases.outputs.gradle-should-release == 'true' && needs.release-gradle.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: gradle-artifacts
          path: gradle

      - name: Download Skills artifacts
        if: needs.check-releases.outputs.skills-should-release == 'true' && needs.release-skills.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: skills-artifacts
          path: skills

      - name: Create tags for successfully released components
        run: |
          # Create tags for successfully released components
          if [ "${{ needs.check-releases.outputs.cli-should-release }}" == "true" ] && [ "${{ needs.release-cli.result }}" == "success" ]; then
            git tag ${{ needs.check-releases.outputs.cli-next-version }}
          fi
          if [ "${{ needs.check-releases.outputs.app-should-release }}" == "true" ] && [ "${{ needs.release-app.result }}" == "success" ]; then
            git tag ${{ needs.check-releases.outputs.app-next-version }}
          fi
          if [ "${{ needs.check-releases.outputs.server-should-release }}" == "true" ] && [ "${{ needs.release-server.result }}" == "success" ]; then
            git tag ${{ needs.check-releases.outputs.server-next-version }}
          fi
          if [ "${{ needs.check-releases.outputs.cache-should-release }}" == "true" ] && [ "${{ needs.release-cache.result }}" == "success" ]; then
            git tag ${{ needs.check-releases.outputs.cache-next-version }}
          fi
          if [ "${{ needs.check-releases.outputs.skills-should-release }}" == "true" ] && [ "${{ needs.release-skills.result }}" == "success" ]; then
            git tag ${{ needs.check-releases.outputs.skills-next-version }}
          fi

      - name: Create CLI GitHub Release
        if: needs.check-releases.outputs.cli-should-release == 'true' && needs.release-cli.result == 'success'
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          repository: tuist/tuist
          name: CLI ${{ needs.check-releases.outputs.cli-next-version-number }}
          tag_name: ${{ needs.check-releases.outputs.cli-next-version }}
          body: ${{ needs.release-cli.outputs.release-notes }}
          files: |
            build/tuist.zip
            build/tuist-linux-x86_64.tar.gz
            build/tuist-linux-aarch64.tar.gz
            build/SHASUMS256.txt
            build/SHASUMS512.txt
            build/ProjectDescription.xcframework.zip

      - name: Create App GitHub Release
        if: needs.check-releases.outputs.app-should-release == 'true' && needs.release-app.result == 'success'
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          repository: tuist/tuist
          name: App ${{ needs.check-releases.outputs.app-next-version-number }}
          tag_name: ${{ needs.check-releases.outputs.app-next-version }}
          body: ${{ needs.release-app.outputs.release-notes }}
          files: |
            app/build/artifacts/SHASUMS256.txt
            app/build/artifacts/SHASUMS512.txt
            app/build/artifacts/Tuist.dmg

      - name: Create Server GitHub Release
        if: needs.check-releases.outputs.server-should-release == 'true' && needs.release-server.result == 'success'
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          repository: tuist/tuist
          name: Server ${{ needs.check-releases.outputs.server-next-version-number }}
          tag_name: ${{ needs.check-releases.outputs.server-next-version }}
          body: |
            Docker image: `ghcr.io/tuist/tuist:${{ needs.check-releases.outputs.server-next-version-number }}`

            ${{ needs.release-server.outputs.release-notes }}

      - name: Create Cache GitHub Release
        if: needs.check-releases.outputs.cache-should-release == 'true' && needs.release-cache.result == 'success'
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          repository: tuist/tuist
          name: Cache ${{ needs.check-releases.outputs.cache-next-version-number }}
          tag_name: ${{ needs.check-releases.outputs.cache-next-version }}
          body: |
            Docker image: `ghcr.io/tuist/cache:${{ needs.check-releases.outputs.cache-next-version-number }}`

            ${{ needs.release-cache.outputs.release-notes }}

      - name: Create Skills GitHub Release
        if: needs.check-releases.outputs.skills-should-release == 'true' && needs.release-skills.result == 'success'
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          repository: tuist/tuist
          name: Skills ${{ needs.check-releases.outputs.skills-next-version-number }}
          tag_name: ${{ needs.check-releases.outputs.skills-next-version }}
          body: |
            GitHub: https://github.com/tuist/agent-skills/releases/tag/${{ needs.check-releases.outputs.skills-next-version-number }}

            ${{ needs.release-skills.outputs.release-notes }}

      - name: Trigger Homebrew Formula Update
        if: needs.check-releases.outputs.cli-should-release == 'true' && needs.release-cli.result == 'success'
        run: |
          SHA256=$(cat build/SHASUMS256.txt | grep tuist.zip | awk '{print $1}')
          mise run --no-prepare cli:release:homebrew-formula --version "${{ needs.check-releases.outputs.cli-next-version }}" --github-token "${{ secrets.TUIST_GITHUB_TOKEN }}" --sha256 "$SHA256"

      - name: Trigger Homebrew Cask Update
        if: needs.check-releases.outputs.app-should-release == 'true' && needs.release-app.result == 'success'
        run: |
          SHA256=$(cat app/build/artifacts/SHASUMS256.txt | grep Tuist.dmg | awk '{print $1}')
          mise run --no-prepare app:release:homebrew-cask --version "${{ needs.check-releases.outputs.app-next-version-number }}" --github-token "${{ secrets.TUIST_GITHUB_TOKEN }}" --sha256 "$SHA256"

      - name: Commit all changes and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Track if any files were added
          FILES_ADDED=false

          # Add files from each component that was released
          if [ "${{ needs.check-releases.outputs.cli-should-release }}" == "true" ] && [ "${{ needs.release-cli.result }}" == "success" ]; then
            git add cli/CHANGELOG.md cli/Sources/TuistConstants/Constants.swift mise.toml
            FILES_ADDED=true
          fi

          if [ "${{ needs.check-releases.outputs.app-should-release }}" == "true" ] && [ "${{ needs.release-app.result }}" == "success" ]; then
            git add app/CHANGELOG.md app/Project.swift app/appcast.xml
            FILES_ADDED=true
          fi

          if [ "${{ needs.check-releases.outputs.server-should-release }}" == "true" ] && [ "${{ needs.release-server.result }}" == "success" ]; then
            git add server/CHANGELOG.md
            FILES_ADDED=true
          fi

          if [ "${{ needs.check-releases.outputs.cache-should-release }}" == "true" ] && [ "${{ needs.release-cache.result }}" == "success" ]; then
            git add cache/CHANGELOG.md
            FILES_ADDED=true
          fi

          if [ "${{ needs.check-releases.outputs.gradle-should-release }}" == "true" ] && [ "${{ needs.release-gradle.result }}" == "success" ]; then
            sed -i 's/public static let gradlePluginVersion = ".*"/public static let gradlePluginVersion = "${{ needs.check-releases.outputs.gradle-next-version-number }}"/' cli/Sources/TuistConstants/Constants.swift
            sed -i 's/id("dev.tuist") version ".*"/id("dev.tuist") version "${{ needs.check-releases.outputs.gradle-next-version-number }}"/' android/settings.gradle.kts
            git add gradle/CHANGELOG.md
            git add gradle/settings.gradle.kts
            git add gradle/src/main/kotlin/dev/tuist/gradle/TuistBuildCache.kt || true
            git add cli/Sources/TuistConstants/Constants.swift
            git add android/settings.gradle.kts
            FILES_ADDED=true
          fi

          if [ "${{ needs.check-releases.outputs.skills-should-release }}" == "true" ] && [ "${{ needs.release-skills.result }}" == "success" ]; then
            git add skills/CHANGELOG.md
            FILES_ADDED=true
          fi

          # Only commit if files were added
          if [ "$FILES_ADDED" = "true" ]; then
            # Check if there are actually changes to commit
            if ! git diff --cached --quiet; then
              # Create commit message
              COMMIT_MSG="[Release]"
              if [ "${{ needs.check-releases.outputs.cli-should-release }}" == "true" ] && [ "${{ needs.release-cli.result }}" == "success" ]; then
                COMMIT_MSG="$COMMIT_MSG Tuist CLI ${{ needs.check-releases.outputs.cli-next-version }}"
              fi
              if [ "${{ needs.check-releases.outputs.app-should-release }}" == "true" ] && [ "${{ needs.release-app.result }}" == "success" ]; then
                COMMIT_MSG="$COMMIT_MSG Tuist App ${{ needs.check-releases.outputs.app-next-version }}"
              fi
              if [ "${{ needs.check-releases.outputs.server-should-release }}" == "true" ] && [ "${{ needs.release-server.result }}" == "success" ]; then
                COMMIT_MSG="$COMMIT_MSG Tuist Server ${{ needs.check-releases.outputs.server-next-version }}"
              fi
              if [ "${{ needs.check-releases.outputs.cache-should-release }}" == "true" ] && [ "${{ needs.release-cache.result }}" == "success" ]; then
                COMMIT_MSG="$COMMIT_MSG Tuist Cache ${{ needs.check-releases.outputs.cache-next-version }}"
              fi
              if [ "${{ needs.check-releases.outputs.gradle-should-release }}" == "true" ] && [ "${{ needs.release-gradle.result }}" == "success" ]; then
                COMMIT_MSG="$COMMIT_MSG Gradle Plugin ${{ needs.check-releases.outputs.gradle-next-version }}"
              fi
              if [ "${{ needs.check-releases.outputs.skills-should-release }}" == "true" ] && [ "${{ needs.release-skills.result }}" == "success" ]; then
                COMMIT_MSG="$COMMIT_MSG Skills ${{ needs.check-releases.outputs.skills-next-version }}"
              fi

              git commit -m "$COMMIT_MSG"
            else
              echo "No changes to commit"
            fi
          else
            echo "No components were released, skipping commit"
          fi

          # Push with retry logic
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts"
            if git pull --rebase origin ${{ github.ref_name }}; then
              if git push origin ${{ github.ref_name }} --tags; then
                echo "Successfully pushed changes and tags"
                break
              fi
            fi
            echo "Push failed, retrying in 5 seconds..."
            sleep 5
            attempt=$((attempt + 1))
          done

          if [ $attempt -gt $max_attempts ]; then
            echo "Failed to push after $max_attempts attempts"
            exit 1
          fi
